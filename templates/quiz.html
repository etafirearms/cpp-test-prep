{% extends "base.html" %}
{% block title %}Quiz - CPP Test Prep{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Hidden quiz data for JavaScript -->
    <script id="quiz-data" type="application/json">
        {{ quiz_data | tojson | safe }}
    </script>

    <!-- Quiz Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 id="quiz-title">{{ quiz_data.title if quiz_data else 'CPP Practice Quiz' }}</h1>
            <div id="quiz-info" class="text-muted">
                <p><strong>Questions:</strong> <span id="total-questions">{{ quiz_data.questions|length if quiz_data and quiz_data.questions else 'Loading...' }}</span></p>
                <p><strong>Domain:</strong> {{ quiz_data.domain if quiz_data else 'General' }}</p>
                <p><strong>Difficulty:</strong> {{ quiz_data.difficulty if quiz_data else 'Medium' }}</p>
            </div>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="progress">
                <div id="progress-bar" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
            </div>
            <small id="progress-text" class="text-muted">0 of {{ quiz_data.questions|length if quiz_data and quiz_data.questions else 0 }} questions answered</small>
        </div>
    </div>

    <!-- Quiz Container -->
    <div id="quiz-container">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 id="question-number" class="mb-0">Loading...</h5>
            </div>
            <div class="card-body">
                <div class="question-section mb-4">
                    <h6 id="question-text">Loading question...</h6>
                </div>
                <div id="question-options">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading options...</p>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-between">
                    <button id="prev-btn" class="btn btn-outline-secondary" disabled>
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    <div>
                        <button id="next-btn" class="btn btn-primary">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                        <button id="submit-btn" class="btn btn-success" style="display: none;">
                            <i class="fas fa-check"></i> Submit Quiz
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Display -->
    <div id="error-display" class="alert alert-danger" style="display: none;">
        <h4><i class="fas fa-exclamation-triangle"></i> Error Loading Quiz</h4>
        <p id="error-message">There was an error loading the quiz.</p>
        <a href="{{ url_for('quiz_selector') }}" class="btn btn-primary">Back to Quiz Selection</a>
    </div>
</div>

<!-- Quiz JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Quiz page loaded');
    
    class QuizManager {
        constructor() {
            this.currentQuestion = 0;
            this.answers = {};
            this.quizData = null;
            this.timeStarted = Date.now();
            this.init();
        }

        init() {
            console.log('Initializing quiz manager...');
            
            // Get quiz data from the hidden script tag
            const quizDataElement = document.getElementById('quiz-data');
            if (!quizDataElement) {
                console.error('Quiz data element not found');
                this.showError('Quiz data not found. Please try refreshing the page.');
                return;
            }

            try {
                this.quizData = JSON.parse(quizDataElement.textContent);
                console.log('Quiz data loaded:', this.quizData);
                
                if (!this.quizData || !this.quizData.questions || this.quizData.questions.length === 0) {
                    throw new Error('No questions found in quiz data');
                }
                
                this.setupEventListeners();
                this.displayQuestion();
                
            } catch (error) {
                console.error('Error parsing quiz data:', error);
                this.showError('Failed to load quiz: ' + error.message);
            }
        }

        setupEventListeners() {
            const nextBtn = document.getElementById('next-btn');
            const prevBtn = document.getElementById('prev-btn');
            const submitBtn = document.getElementById('submit-btn');

            if (nextBtn) nextBtn.addEventListener('click', () => this.nextQuestion());
            if (prevBtn) prevBtn.addEventListener('click', () => this.previousQuestion());
            if (submitBtn) submitBtn.addEventListener('click', () => this.submitQuiz());

            // Answer selection
            document.addEventListener('change', (e) => {
                if (e.target.type === 'radio' && e.target.name === 'answer') {
                    this.answers[this.currentQuestion] = e.target.value;
                    console.log('Answer selected:', e.target.value);
                    this.updateProgress();
                }
            });
        }

        displayQuestion() {
            if (!this.quizData || !this.quizData.questions) return;

            const question = this.quizData.questions[this.currentQuestion];
            if (!question) {
                console.error('Question not found at index:', this.currentQuestion);
                return;
            }

            // Update question number and text
            const questionNumber = document.getElementById('question-number');
            const questionText = document.getElementById('question-text');
            const questionOptions = document.getElementById('question-options');

            if (questionNumber) {
                questionNumber.textContent = `Question ${this.currentQuestion + 1} of ${this.quizData.questions.length}`;
            }

            if (questionText) {
                questionText.textContent = question.question;
            }

            // Display options
            if (questionOptions && question.options) {
                questionOptions.innerHTML = '';
                
                Object.entries(question.options).forEach(([key, value]) => {
                    const isSelected = this.answers[this.currentQuestion] === key;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'form-check mb-3 p-3 border rounded';
                    optionDiv.style.cursor = 'pointer';
                    optionDiv.innerHTML = `
                        <input class="form-check-input" type="radio" name="answer" value="${key}" id="option-${key}" ${isSelected ? 'checked' : ''}>
                        <label class="form-check-label w-100" for="option-${key}" style="cursor: pointer;">
                            <strong>${key}.</strong> ${value}
                        </label>
                    `;
                    
                    // Add click handler to entire div
                    optionDiv.addEventListener('click', () => {
                        const radio = optionDiv.querySelector('input[type="radio"]');
                        radio.checked = true;
                        radio.dispatchEvent(new Event('change'));
                    });
                    
                    questionOptions.appendChild(optionDiv);
                });
            }

            this.updateNavigation();
            this.updateProgress();
        }

        updateNavigation() {
            const nextBtn = document.getElementById('next-btn');
            const prevBtn = document.getElementById('prev-btn');
            const submitBtn = document.getElementById('submit-btn');

            if (prevBtn) {
                prevBtn.disabled = this.currentQuestion === 0;
            }

            const isLastQuestion = this.currentQuestion === this.quizData.questions.length - 1;
            
            if (nextBtn) {
                nextBtn.style.display = isLastQuestion ? 'none' : 'inline-block';
            }
            
            if (submitBtn) {
                submitBtn.style.display = isLastQuestion ? 'inline-block' : 'none';
            }
        }

        updateProgress() {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            const answered = Object.keys(this.answers).length;
            const total = this.quizData.questions.length;
            const percentage = (answered / total) * 100;
            
            if (progressBar) {
                progressBar.style.width = `${percentage}%`;
                progressBar.setAttribute('aria-valuenow', percentage);
            }
            
            if (progressText) {
                progressText.textContent = `${answered} of ${total} questions answered`;
            }
        }

        nextQuestion() {
            if (this.currentQuestion < this.quizData.questions.length - 1) {
                this.currentQuestion++;
                this.displayQuestion();
            }
        }

        previousQuestion() {
            if (this.currentQuestion > 0) {
                this.currentQuestion--;
                this.displayQuestion();
            }
        }

        async submitQuiz() {
            console.log('Submitting quiz with answers:', this.answers);
            
            // Check if all questions are answered
            const unanswered = [];
            for (let i = 0; i < this.quizData.questions.length; i++) {
                if (!this.answers[i]) {
                    unanswered.push(i + 1);
                }
            }

            if (unanswered.length > 0) {
                const proceed = confirm(`You have ${unanswered.length} unanswered questions. Submit anyway?`);
                if (!proceed) return;
            }
            
            const submitBtn = document.getElementById('submit-btn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            }

            try {
                const response = await fetch('/submit-quiz', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        quiz_type: this.quizData.quiz_type,
                        domain: this.quizData.domain,
                        answers: this.answers,
                        questions: this.quizData.questions,
                        time_taken: Math.round((Date.now() - this.timeStarted) / 60000)
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    this.showResults(result);
                } else {
                    throw new Error(result.error || 'Unknown error');
                }

            } catch (error) {
                console.error('Submit error:', error);
                alert('Error submitting quiz: ' + error.message);
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-check"></i> Submit Quiz';
                }
            }
        }

        showResults(result) {
            const container = document.getElementById('quiz-container');
            if (container) {
                const passColor = result.score >= 70 ? 'success' : 'danger';
                const passText = result.score >= 70 ? 'Great job!' : 'Keep studying!';
                
                container.innerHTML = `
                    <div class="card">
                        <div class="card-body text-center">
                            <h2 class="card-title">Quiz Complete!</h2>
                            <div class="display-1 text-${passColor} mb-3">${result.score}%</div>
                            <p class="lead">${result.correct} out of ${result.total} correct</p>
                            <p class="text-muted">${passText}</p>
                            
                            ${result.time_taken ? `<p><small>Completed in ${result.time_taken} minutes</small></p>` : ''}
                            
                            <div class="mt-4">
                                <a href="/quiz-selector" class="btn btn-primary me-2">Take Another Quiz</a>
                                <a href="/dashboard" class="btn btn-outline-secondary">Return to Dashboard</a>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        showError(message) {
            console.error('Quiz error:', message);
            const errorDisplay = document.getElementById('error-display');
            const errorMessage = document.getElementById('error-message');
            const quizContainer = document.getElementById('quiz-container');
            
            if (errorDisplay && errorMessage) {
                errorMessage.textContent = message;
                errorDisplay.style.display = 'block';
            }
            
            if (quizContainer) {
                quizContainer.style.display = 'none';
            }
        }
    }

    // Initialize quiz manager
    new QuizManager();
});
</script>

<style>
.form-check {
    transition: background-color 0.2s ease;
}

.form-check:hover {
    background-color: #f8f9fa;
}

.form-check input[type="radio"]:checked + label {
    font-weight: 600;
    color: #0d6efd;
}

.progress {
    height: 8px;
}

.question-section h6 {
    font-size: 1.1rem;
    line-height: 1.6;
}
</style>
{% endblock %}
