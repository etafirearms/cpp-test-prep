{% extends "base.html" %}

{% block title %}{{ quiz_data.title }} - CPP Test Prep{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">
        <h4><i class="fas fa-list-check me-2"></i>{{ quiz_data.title }}</h4>
        <div class="progress mt-2" role="progressbar" aria-label="Quiz progress">
          <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
        </div>
      </div>
      <div class="card-body">
        <form id="quiz-form">
          {% for q in quiz_data.questions %}
            {% set i = loop.index0 %}
            <div class="question mb-4" data-question="{{ i }}">
              <h5>{{ loop.index }}. {{ q.question }}</h5>
              {% for key, option in q.options.items() %}
                <div class="form-check quiz-option p-3 mb-2" onclick="selectOption({{ i }}, '{{ key }}')">
                  <input class="form-check-input" type="radio" name="question_{{ i }}" value="{{ key }}" id="q{{ i }}_{{ key }}">
                  <label class="form-check-label w-100" for="q{{ i }}_{{ key }}">
                    <strong>{{ key }}.</strong> {{ option }}
                  </label>
                </div>
              {% endfor %}
            </div>
          {% endfor %}

          <div class="text-center">
            <button type="button" class="btn btn-primary btn-lg" onclick="submitQuiz()">
              <i class="fas fa-check me-2"></i>Submit Quiz
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1" aria-labelledby="resultsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="resultsModalLabel" class="modal-title">Quiz Results</h5>
      </div>
      <div class="modal-body" id="resultsContent">
        <!-- Results will be loaded here -->
      </div>
      <div class="modal-footer">
        <a href="{{ url_for('dashboard') }}" class="btn btn-primary">Back to Dashboard</a>
        <a href="{{ url_for('quiz', quiz_type=quiz_type) }}" class="btn btn-secondary">Take Again</a>
      </div>
    </div>
  </div>
</div>

<style>
  /* highlight selected option */
  .quiz-option.selected {
    border: 1px solid #0d6efd;
    background: #eef5ff;
    border-radius: .5rem;
  }
</style>
{% endblock %}

{% block scripts %}
<script>
let selectedAnswers = {};
const totalQuestions = {{ quiz_data.questions|length }};

function selectOption(questionIndex, option) {
  selectedAnswers[questionIndex] = option;

  // Update visual selection
  document.querySelectorAll(`input[name="question_${questionIndex}"]`).forEach(input => {
    input.checked = (input.value === option);
    const optionDiv = input.closest('.quiz-option');
    if (input.checked) {
      optionDiv.classList.add('selected');
    } else {
      optionDiv.classList.remove('selected');
    }
  });

  // Update progress
  const progress = (Object.keys(selectedAnswers).length / totalQuestions) * 100;
  const bar = document.getElementById('progress-bar');
  bar.style.width = progress + '%';
  bar.setAttribute('aria-valuenow', progress.toFixed(0));
}

function submitQuiz() {
  if (Object.keys(selectedAnswers).length < totalQuestions) {
    alert('Please answer all questions before submitting.');
    return;
  }

  const quizData = {
    quiz_type: '{{ quiz_type }}',
    answers: selectedAnswers,
    questions: {{ quiz_data.questions|tojson }}
  };

  fetch('{{ url_for("submit_quiz") }}', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(quizData)
  })
  .then(res => res.json())
  .then(data => showResults(data))
  .catch(() => alert('Error submitting quiz. Please try again.'));
}

function showResults(data) {
  let html = `
    <div class="text-center mb-4">
      <h3>Score: ${data.correct}/${data.total} (${data.score.toFixed(1)}%)</h3>
      <div class="progress mb-3">
        <div class="progress-bar ${data.score >= 70 ? 'bg-success' : 'bg-danger'}" style="width: ${data.score}%"></div>
      </div>
    </div>
    <div class="results-details">
  `;

  data.results.forEach((result, index) => {
    html += `
      <div class="card mb-3">
        <div class="card-body">
          <h6>Question ${index + 1}: ${escapeHtml(result.question)}</h6>
          <p><strong>Your Answer:</strong> ${escapeHtml(result.user_answer || 'â€”')}
             <span class="badge ${result.is_correct ? 'bg-success' : 'bg-danger'}">
               ${result.is_correct ? 'Correct' : 'Incorrect'}
             </span>
          </p>
          ${!result.is_correct ? `<p><strong>Correct Answer:</strong> ${escapeHtml(result.correct_answer)}</p>` : ''}
          ${result.explanation ? `<p class="text-muted"><em>${escapeHtml(result.explanation)}</em></p>` : ''}
        </div>
      </div>
    `;
  });

  html += '</div>';

  document.getElementById('resultsContent').innerHTML = html;
  new bootstrap.Modal(document.getElementById('resultsModal')).show();
}

// simple HTML escape for safety
function escapeHtml(str) {
  if (str == null) return '';
  return String(str)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}
</script>
{% endblock %}
