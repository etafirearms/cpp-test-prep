{% extends "base.html" %}

{% block title %}Dashboard - CPP Test Prep{% endblock %}

{% block content %}
<div class="row g-3">
  <div class="col-12">
    <div class="card p-4">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="mb-0">Welcome, {{ user.first_name }}</h2>
        <span class="badge {% if user.subscription_status in ['active','trial'] %}bg-success{% elif user.subscription_status=='past_due' %}bg-warning text-dark{% else %}bg-danger{% endif %}">
          {{ user.subscription_status|capitalize }}
        </span>
      </div>
      <p class="text-muted mb-0">
        Member since {{ moment(user.created_at).format('LL') }}
        {% if user.subscription_end_date %}
          • Subscription ends {{ moment(user.subscription_end_date).fromNow() }}
        {% endif %}
        {% if days_left %}
          • <strong>{{ days_left }}</strong> day{{ 's' if days_left != 1 }} left
        {% endif %}
      </p>
    </div>
  </div>

  <!-- Quick actions -->
  <div class="col-lg-8">
    <div class="card p-4">
      <h5 class="mb-3"><i class="fas fa-clipboard-list text-primary me-2"></i>Your Stats</h5>
      <div class="row text-center">
        <div class="col-6 col-md-3 mb-3">
          <div class="p-3 border rounded-3 bg-light">
            <div class="h4 mb-0">{{ quiz_stats.total_quizzes }}</div>
            <small class="text-muted">Quizzes</small>
          </div>
        </div>
        <div class="col-6 col-md-3 mb-3">
          <div class="p-3 border rounded-3 bg-light">
            <div class="h4 mb-0">{{ quiz_stats.avg_score|round(1) }}%</div>
            <small class="text-muted">Avg Score</small>
          </div>
        </div>
        <div class="col-6 col-md-3 mb-3">
          <div class="p-3 border rounded-3 bg-light">
            <div class="h4 mb-0">{{ quiz_stats.best_score|round(1) }}%</div>
            <small class="text-muted">Best Score</small>
          </div>
        </div>
        <div class="col-6 col-md-3 mb-3">
          <div class="p-3 border rounded-3 bg-light">
            <div class="h4 mb-0">{{ (total_study_time or 0) }}</div>
            <small class="text-muted">Study mins</small>
          </div>
        </div>
      </div>

      <div class="d-flex flex-wrap gap-2 mb-2">
        <a href="{{ url_for('quiz_selector') }}" class="btn btn-outline-primary">
          <i class="fas fa-bolt me-1"></i> Take a Quiz
        </a>
        <a href="{{ url_for('flashcards') }}" class="btn btn-outline-info">
          <i class="fas fa-clone me-1"></i> Flashcards
        </a>
        <a href="{{ url_for('study') }}" class="btn btn-outline-success">
          <i class="fas fa-book me-1"></i> Study With AI
        </a>
        <a href="{{ url_for('progress') }}" class="btn btn-outline-secondary">
          <i class="fas fa-chart-line me-1"></i> See Progress
        </a>
      </div>

      {% if quiz_stats.quiz_types_completed %}
        <small class="text-muted">Completed types:
          {{ quiz_stats.quiz_types_completed|sort|join(', ') }}
        </small>
      {% endif %}
    </div>
  </div>

  <!-- Subscription / CTA -->
  <div class="col-lg-4">
    <div class="card p-4">
      <h5 class="mb-3"><i class="fas fa-id-card text-primary me-2"></i>Your Plan</h5>
      <p class="mb-2">Current plan: <strong>{{ (user.subscription_plan or 'trial')|replace('_', ' ')|title }}</strong></p>
      {% if user.subscription_status in ['expired','past_due'] %}
        <a href="{{ url_for('subscribe') }}" class="btn btn-primary w-100">
          <i class="fas fa-crown me-1"></i> Subscribe / Renew
        </a>
      {% elif user.subscription_status == 'trial' %}
        <a href="{{ url_for('subscribe') }}" class="btn btn-primary w-100">
          <i class="fas fa-rocket me-1"></i> Upgrade Now
        </a>
        <small class="text-muted d-block mt-2">
          Trial ends {{ moment(user.subscription_end_date).calendar() }}
        </small>
      {% else %}
        <div class="alert alert-success mb-0">
          <i class="fas fa-check-circle me-1"></i> Your subscription is active.
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Recent Quizzes -->
  <div class="col-lg-6">
    <div class="card p-4">
      <h5 class="mb-3"><i class="fas fa-list-check text-primary me-2"></i>Recent Quizzes</h5>
      {% if recent_quizzes %}
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>Type</th>
                <th>Domain</th>
                <th>Score</th>
                <th>Completed</th>
              </tr>
            </thead>
            <tbody>
              {% for q in recent_quizzes %}
              <tr>
                <td>{{ q.quiz_type }}</td>
                <td>{{ q.domain or 'general' }}</td>
                <td>{{ q.score|round(1) }}%</td>
                <td>{{ moment(q.completed_at).fromNow() }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted mb-0">No quizzes yet — start with a <a href="{{ url_for('quiz_selector') }}">practice quiz</a>.</p>
      {% endif %}
    </div>
  </div>

  <!-- Recent Activity -->
  <div class="col-lg-6">
    <div class="card p-4">
      <h5 class="mb-3"><i class="fas fa-bell text-primary me-2"></i>Recent Activity</h5>
      {% if recent_activities %}
        <ul class="list-group list-group-flush">
          {% for a in recent_activities %}
          <li class="list-group-item d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">{{ a.activity|replace('_',' ')|title }}</div>
              {% if a.details %}
                <small class="text-muted">{{ a.details }}</small>
              {% endif %}
            </div>
            <small class="text-muted">{{ moment(a.timestamp).fromNow() }}</small>
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted mb-0">No activity yet.</p>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
