{% extends "base.html" %}
{% block title %}Choose a Quiz · CPP Test Prep{% endblock %}

{% block content %}
<div class="row mb-4">
  <div class="col-12">
    <div class="d-flex align-items-center">
      <i class="fas fa-clipboard-list fa-lg text-primary me-2"></i>
      <h2 class="mb-0">Choose a Quiz</h2>
    </div>
    <p class="text-light mt-2">Pick a quiz type, optionally select a CPP domain and difficulty, then start practicing.</p>
  </div>
</div>

<div class="row g-3">
  <!-- Left: Quiz Type -->
  <div class="col-lg-4">
    <div class="card p-3">
      <h5 class="mb-3"><i class="fas fa-list-check text-primary me-2"></i>Quiz Type</h5>
      <div class="list-group" id="quizTypeList">
        {% for key, q in quiz_types.items() %}
          <button
            type="button"
            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start"
            data-quiz-key="{{ key }}"
          >
            <div class="ms-2 me-auto">
              <div class="fw-bold">{{ q.name }}</div>
              <small class="text-muted">{{ q.description }}</small>
            </div>
            <span class="badge bg-primary rounded-pill">{{ q.questions }}</span>
          </button>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Middle: Domain -->
  <div class="col-lg-4">
    <div class="card p-3">
      <h5 class="mb-3"><i class="fas fa-diagram-project text-primary me-2"></i>Domain (optional)</h5>
      <div class="list-group" id="domainList">
        <!-- General -->
        <button type="button" class="list-group-item list-group-item-action active" data-domain="">
          <div class="fw-bold">General (all domains)</div>
          <small class="text-light">Mix of all core CPP domains</small>
        </button>

        {% for dkey, dinfo in cpp_domains.items() %}
          <button
            type="button"
            class="list-group-item list-group-item-action"
            data-domain="{{ dkey }}"
          >
            <!-- Header + mastery badge row -->
            <div class="d-flex justify-content-between align-items-center">
              <div class="fw-bold">{{ dinfo.name }}</div>
              {% set prog = user_progress.get(dkey) %}
              {% if prog %}
                {% if prog.mastery_level == 'mastered' %}
                  <span class="badge bg-success">Mastered</span>
                {% elif prog.mastery_level == 'good' %}
                  <span class="badge bg-warning text-dark">Good</span>
                {% else %}
                  <span class="badge bg-secondary">Practice</span>
                {% endif %}
              {% endif %}
            </div>

            <!-- Topics + stats line -->
            <small class="text-muted">
              {{ ', '.join(dinfo.topics[:3]) }}{% if dinfo.topics|length > 3 %}, …{% endif %}
              {% if prog %} • Avg: {{ '%.0f'|format(prog.average_score) }}% • Streak: {{ prog.consecutive_good_scores }}{% endif %}
            </small>
          </button>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Right: Options + Start -->
  <div class="col-lg-4">
    <div class="card p-3">
      <h5 class="mb-3"><i class="fas fa-sliders text-primary me-2"></i>Options</h5>

      <label class="form-label">Difficulty</label>
      <div class="btn-group w-100 mb-3" role="group" id="difficultyGroup">
        <input type="radio" class="btn-check" name="difficulty" id="diffEasy" autocomplete="off" value="easy">
        <label class="btn btn-outline-success" for="diffEasy"><i class="fas fa-seedling me-1"></i>Easy</label>

        <input type="radio" class="btn-check" name="difficulty" id="diffMedium" autocomplete="off" value="medium" checked>
        <label class="btn btn-outline-warning" for="diffMedium"><i class="fas fa-circle-half-stroke me-1"></i>Medium</label>

        <input type="radio" class="btn-check" name="difficulty" id="diffHard" autocomplete="off" value="hard">
        <label class="btn btn-outline-danger" for="diffHard"><i class="fas fa-fire me-1"></i>Hard</label>
      </div>

      <div class="border rounded p-2 mb-3">
        <div class="small text-muted mb-1">Selected</div>
        <div><strong>Quiz:</strong> <span id="selQuiz">Practice Quiz</span></div>
        <div><strong>Domain:</strong> <span id="selDomain">General</span></div>
        <div><strong>Difficulty:</strong> <span id="selDiff">Medium</span></div>
      </div>

      <button id="startBtn" class="btn btn-primary w-100">
        <i class="fas fa-play me-1"></i> Start Quiz
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // --- State ---
  let selectedQuizKey = 'practice';
  let selectedQuizName = 'Practice Quiz';
  let selectedDomainKey = '';
  let selectedDomainName = 'General';
  let selectedDifficulty = 'medium';

  // --- Quiz type buttons ---
  document.querySelectorAll('#quizTypeList button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#quizTypeList button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      selectedQuizKey = btn.getAttribute('data-quiz-key');
      selectedQuizName = btn.querySelector('.fw-bold').textContent.trim();
      document.getElementById('selQuiz').textContent = selectedQuizName;
    });
  });
  // Default activate "practice" (or first if not present)
  const firstQuizBtn =
    document.querySelector('#quizTypeList button[data-quiz-key="practice"]') ||
    document.querySelector('#quizTypeList button');
  if (firstQuizBtn) firstQuizBtn.classList.add('active');

  // --- Domain buttons ---
  document.querySelectorAll('#domainList button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#domainList button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      selectedDomainKey = btn.getAttribute('data-domain') || '';
      selectedDomainName = btn.querySelector('.fw-bold')?.textContent.trim() || 'General';
      document.getElementById('selDomain').textContent = selectedDomainName;
    });
  });

  // --- Difficulty radios ---
  document.querySelectorAll('#difficultyGroup input[name="difficulty"]').forEach(r => {
    r.addEventListener('change', () => {
      selectedDifficulty = r.value;
      document.getElementById('selDiff').textContent = r.labels[0].innerText.trim();
    });
  });

  // --- Start button ---
  document.getElementById('startBtn').addEventListener('click', () => {
    const params = new URLSearchParams();
    if (selectedDomainKey) params.set('domain', selectedDomainKey);
    if (selectedDifficulty) params.set('difficulty', selectedDifficulty);

    // Your /quiz/<quiz_type> route validates quiz_type against QUIZ_TYPES
    window.location.href = `/quiz/${encodeURIComponent(selectedQuizKey)}?${params.toString()}`;
  });
</script>
{% endblock %}
